/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0xa69878 from'./../users/user.js';import _0x537049 from'./../websocketgateway/websocketgateway.js';import _0x45d57d from'./responses/sessionsconnectresponse.js';import _0x1e83c2 from'./messages/sessionsconnectmessage.js';import _0x1989e6 from'./messages/socketconnectmessage.js';import _0x18333a from'./messages/socketdisconnectmessage.js';import _0x2cee1d from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{constructor(_0x513c04,_0x316f74){super({'idProperty':'id'}),this['_id']=_0x513c04,this['_sessionType']=_0x316f74,this['_handlers']=new Map(),this['_eventsQueue']=[],this['_isRunning']=!0x1;}async['connect'](_0x52e4b7){this['_wsGateway']=_0x52e4b7,this['stopListening'](_0x52e4b7,'change:state');const _0xdf991d=new _0x1e83c2(this['_id'],this['_sessionType']);let _0x1220f5;try{const _0x557891=await this['_wsGateway']['_sendRequest'](0x3,_0x1e83c2['TYPE'],_0x2cee1d['encode'](_0xdf991d));_0x1220f5=_0x2cee1d['decode'](_0x557891,_0x45d57d);}catch(_0x77bb46){_0x1220f5=new _0x45d57d(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x1220f5['channel'],this['_sessionType']);const _0x5447a9=await async function(_0x48f83b,_0x1bdfb9){const _0x19de67=_0x1bdfb9['map'](_0x29c86a=>_0x29c86a['userId']),_0xec956a=_0x19de67['length']?await _0xa69878['getMany'](_0x48f83b,_0x19de67):[];return _0x1bdfb9['map'](_0x1f22ca=>{const _0x2fd705={'id':_0x1f22ca['id'],'role':_0x1f22ca['role'],'permissions':_0x1f22ca['permissions']};return _0x2fd705['user']=_0x1f22ca['userId']&&_0xec956a['find'](_0x1177fc=>_0x1177fc['id']===_0x1f22ca['userId'])||new _0xa69878(),_0x2fd705;});}(this['_wsGateway'],_0x1220f5['sockets']);for(const _0x4eefa1 of _0x5447a9)super['add'](_0x4eefa1);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x19162a,_0x5e8c66,_0x3459e0)=>this['_onWsGatewayStateChange'](_0x3459e0),{'priority':_0x537049['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x3b64ba=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x3b64ba&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x3b64ba&&this['stopListening']();}}['add'](_0x14d880,_0x580c8a){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x153371){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x4fecc0,_0x3e48ac,_0x2c5778){this['_channel']=_0x4fecc0['_getChannel'](_0x2c5778,_0x3e48ac),this['_channel']&&(this['_addHandler'](this['_channel'],_0x1989e6['TYPE'],async _0x3d8ad4=>{const _0x457fc1=_0x2cee1d['decode'](_0x3d8ad4,_0x1989e6);if(-0x1===this['getIndex'](_0x457fc1['id'])){const _0x51cfef={'id':_0x457fc1['id'],'role':_0x457fc1['role'],'permissions':_0x457fc1['permissions']};_0x457fc1['userId']&&(_0x51cfef['user']=await _0xa69878['get'](_0x4fecc0,_0x457fc1['userId'])),super['add'](_0x51cfef);}}),this['_addHandler'](this['_channel'],_0x18333a['TYPE'],_0x54d9a4=>{const _0x19597a=_0x2cee1d['decode'](_0x54d9a4,_0x18333a);-0x1!==this['getIndex'](_0x19597a['id'])&&super['remove'](_0x19597a['id']);}));}async['_onWsGatewayStateChange'](_0x744d11){_0x744d11===_0x537049['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x744d11===_0x537049['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x5c0ac4;for(this['_isRunning']=!0x0;_0x5c0ac4=this['_eventsQueue']['shift']();){const _0x395fe6=this['_handlers']['get'](_0x5c0ac4['eventName']);_0x395fe6&&await _0x395fe6(_0x5c0ac4['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0xc9e65f,_0x539d0c,_0x50f73f){const _0x1555ff=_0xc9e65f['getEventName'](_0x539d0c,!0x0);this['listenTo'](_0xc9e65f,_0x1555ff,async(_0x91c766,_0x56f73c)=>{const _0x544dfb=_0x91c766['name'];this['_eventsQueue']['push']({'eventName':_0x544dfb,'data':_0x56f73c}),await this['_runQueue']();}),this['_handlers']['set'](_0x1555ff,_0x50f73f);}}