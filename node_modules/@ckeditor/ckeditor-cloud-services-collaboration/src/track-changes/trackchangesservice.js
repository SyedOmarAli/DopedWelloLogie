/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x2859a8 from'./../messagescompressor.js';import _0x12382f from'./messages/addsuggestionmessage.js';import _0x50bc03 from'./responses/addsuggestionresponse.js';import _0x1d64e6 from'./messages/getsuggestionmessage.js';import _0x44c63e from'./responses/getsuggestionresponse.js';import _0x42b28b from'./messages/getallsuggestionsmessage.js';import _0x5b150b from'./responses/getallsuggestionsresponse.js';import _0x20db41 from'./messages/updatesuggestionmessage.js';import _0x383d29 from'./messages/connectmessage.js';import _0x135b3b from'./responses/connectresponse.js';import _0x55455e from'../ckeditorcloudserviceserror.js';import _0x9f3653,{WEB_SOCKET_GATEWAY_STATES}from'../websocketgateway/websocketgateway.js';import _0x5a25fc from'../errors/ServiceNotConnectedError.js';import _0x588e9b from'../ckeditorcloudservicesservererror.js';import _0x36a0fc from'./messages/batchUpdateSuggestionsStateMessage.js';export const _SERVICE=0xa;class TrackChangesService extends EmitterMixin(){constructor(_0x369cdd){super(),this['_documentId']=_0x369cdd,this['_isConnected']=!0x1;}get['isConnected'](){return this['_isConnected'];}async['connect'](_0x136c4d){if(this['_isConnected'])return;if(_0x136c4d['state']!==WEB_SOCKET_GATEWAY_STATES['CONNECTED'])throw new _0x55455e('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x136c4d);const _0x5684a3=new _0x383d29(this['_documentId']);this['_wsGateway']=_0x136c4d,this['stopListening'](_0x136c4d,'change:state');const _0x1f93f3=await _0x136c4d['_sendRequest'](0xa,_0x383d29['TYPE'],_0x2859a8['encode'](_0x5684a3)),_0x1c8dad=_0x2859a8['decode'](_0x1f93f3,_0x135b3b);return this['listenTo'](_0x136c4d,'change:state',(_0x590db8,_0x1393f0,_0x186f7d)=>this['_onWsGatewayStateChange'](_0x186f7d),{'priority':_0x9f3653['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x136c4d,_0x1c8dad['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x1c8dad['suggestions'];}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['add'](_0x3ce89f,_0xb4f258,_0x5e9b76,_0x19b240=null,_0x5b70c3){const _0x597087=new _0x12382f(_0x3ce89f,this['_documentId'],_0xb4f258,_0x5e9b76,_0x19b240,_0x5b70c3),_0x2f45d4=await this['_sendRequest'](_0x12382f['TYPE'],_0x597087);return _0x2859a8['decode'](_0x2f45d4,_0x50bc03);}async['get'](_0xffacc1,_0x229d83=0x1){const _0x2f9029=new _0x1d64e6(_0xffacc1,this['_documentId']);try{const _0xd2ab0e=await this['_sendRequest'](_0x1d64e6['TYPE'],_0x2f9029);return _0x2859a8['decode'](_0xd2ab0e,_0x44c63e);}catch(_0x53846d){if('CKEditorCloudServicesServerError'===_0x53846d['name']&&'404'===_0x53846d['code']&&_0x229d83<0x5)return await(_0x30b557=0x64*_0x229d83,new Promise(_0x51a091=>{setTimeout(_0x51a091,_0x30b557);})),this['get'](_0xffacc1,_0x229d83+0x1);if('CKEditorCloudServicesServerError'===_0x53846d['name'])throw _0x53846d;throw _0x588e9b['fromPublicError'](_0x53846d);}var _0x30b557;}async['getAll'](){const _0xba7ed9=new _0x42b28b(this['_documentId']),_0x33dd05=await this['_sendRequest'](_0x42b28b['TYPE'],_0xba7ed9),{suggestions:_0x3d9352}=_0x2859a8['decode'](_0x33dd05,_0x5b150b);return _0x3d9352;}async['update'](_0x137d07,_0x352ecc={}){const {hasComments:_0x3fce65,state:_0x5e6fca,attributes:_0x28bbd2}=_0x352ecc,_0x1be30a=void 0x0!==_0x3fce65,_0x44a3a5=new _0x20db41(_0x137d07,this['_documentId'],_0x3fce65,_0x1be30a,_0x5e6fca,_0x28bbd2);await this['_sendRequest'](_0x20db41['TYPE'],_0x44a3a5);}async['batchUpdateState'](_0x212cae){const _0x52540d=new _0x36a0fc(_0x212cae['ids'],this['_documentId'],_0x212cae['state']);await this['_sendRequest'](_0x36a0fc['TYPE'],_0x52540d);}['_connectToChannel'](_0x57833a,_0x45de54){this['_channel']=_0x57833a['_getChannel'](TrackChangesService['_SERVICE'],_0x45de54),this['_channel']&&this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x20db41['TYPE']),(_0x4170eb,_0x2f79ce)=>{const _0x4e5d23=_0x2859a8['decode'](_0x2f79ce,_0x20db41);this['fire']('suggestionUpdated',_0x4e5d23);});}['_onWsGatewayStateChange'](_0x4cb2ce){_0x4cb2ce===WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&this['disconnect']();}['_sendRequest'](_0x1e3608,_0x17a440){if(!this['_wsGateway']||!this['_isConnected'])throw new _0x5a25fc('Track\x20Changes',this);return this['_wsGateway']['_sendRequest'](0xa,_0x1e3608,_0x2859a8['encode'](_0x17a440));}}TrackChangesService['_SERVICE']=0xa;export default TrackChangesService;