/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{v4 as _0x2a735b}from'uuid';import{EmitterMixin}from'ckeditor5/src/utils.js';import _0x3b246e from'./../messagescompressor.js';import _0x4065fe from'./../sessions/sessions.js';import _0x4bb882 from'./messages/collaborativeeditingconnectmessage.js';import _0x4ae3d5 from'./messages/collaborativeeditingupdatemessage.js';import _0x35ed24 from'./messages/collaborativeeditingreconnectmessage.js';import _0xcd13b3 from'./responses/collaborativeeditingresponse.js';import _0x44ec82 from'./responses/collaborativeeditingconnectresponse.js';import _0x560f6e from'./../websocketgateway/websocketgateway.js';import _0x3fdce9 from'../ckeditorcloudserviceserror.js';import _0x565bad from'../errors/ServiceNotConnectedError.js';import _0x2d8bb6 from'./responses/getdocumentdetailsresponse.js';import _0x35dc2f from'./messages/getdocumentdetailsmessage.js';export const _SERVICE=0x1;class CollaborativeEditingService extends EmitterMixin(){constructor(_0x1c894e,_0x121e66){if(super(),!_0x1c894e)throw new TypeError('Param\x20\x22bundleVersion\x22\x20must\x20be\x20provided.');this['_id']=null!=_0x121e66?_0x121e66:_0x2a735b(),this['_isConnected']=!0x1,this['_bundleVersion']=_0x1c894e;}['getId'](){return this['_id'];}['isConnected'](){return this['_isConnected'];}['connect'](_0x433e7b,_0x49547d={'buffers':[],'types':[]},_0x156341){const _0x423601=new _0x4bb882(this['getId'](),_0x49547d['buffers'],_0x49547d['types'],this['_bundleVersion'],_0x156341);return this['_connect'](_0x433e7b,_0x423601);}['reconnect'](_0x537d40,_0x4f041a){if(this['isConnected']())throw new _0x3fdce9('Cannot\x20reconnect\x20to\x20already\x20connected\x20service.',_0x537d40);return this['_connect'](_0x537d40,new _0x35ed24(this['getId'](),_0x4f041a,this['_bundleVersion']));}['disconnect'](){this['_isConnected']&&(this['_isConnected']=!0x1,this['_wsGateway']&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_connectedSessions']&&(this['_connectedSessions']['disconnect'](),this['_connectedSessions']=void 0x0),this['fire']('disconnected'),this['stopListening']());}async['getDocumentDetails'](){const _0x49ac7d=new _0x35dc2f(this['getId']());if(!this['_wsGateway'])throw new _0x565bad('Collaborative\x20Editing',this);const _0x1bf664=await this['_wsGateway']['_sendRequest'](0x1,_0x35dc2f['TYPE'],_0x3b246e['encode'](_0x49ac7d));return _0x3b246e['decode'](_0x1bf664,_0x2d8bb6);}async['sendOperations'](_0x447d77,_0x59cbce,_0x371a55){if(!_0x447d77||!_0x447d77['types']||!_0x447d77['types']['length'])throw new _0x3fdce9('Cannot\x20send\x20empty\x20update.',this['_wsGateway']);const _0x59833f='number'==typeof _0x59cbce?_0x59cbce:parseInt(_0x59cbce);if(!Number['isInteger'](_0x59833f)||_0x59833f<0x0)throw new _0x3fdce9('Base\x20version\x20not\x20provided.',this['_wsGateway']);const _0xaaf051=new _0x4ae3d5(this['getId'](),_0x447d77['buffers'],_0x447d77['types'],_0x59833f,[],_0x371a55);if(!this['_wsGateway']||!this['_isConnected'])throw new _0x565bad('Collaborative\x20Editing',this);const _0x10b74b=await this['_wsGateway']['_sendRequest'](0x1,_0x4ae3d5['TYPE'],_0x3b246e['encode'](_0xaaf051));return _0x3b246e['decode'](_0x10b74b,_0xcd13b3);}async['getConnectedSessions'](){if(!this['_isConnected'])throw new _0x565bad('Collaborative\x20Editing',this);return this['_connectedSessions']||(this['_connectedSessions']=await _0x4065fe['getConnectedSessions'](this['_wsGateway'],this['_id'],0x1)),this['_connectedSessions'];}static['getConnectedSessions'](_0x3bfe73,_0x5e216a){return _0x4065fe['getConnectedSessions'](_0x3bfe73,_0x5e216a,0x1);}async['_connect'](_0x309b57,_0x38c822){if(this['isConnected']())return;if(_0x309b57['state']!==_0x560f6e['STATE_CONNECTED'])throw new _0x3fdce9('WebSocket\x20Gateway\x20is\x20not\x20connected.',_0x309b57);this['_wsGateway']=_0x309b57,this['stopListening'](_0x309b57,'change:state');const _0x23fbea=await _0x309b57['_sendRequest'](0x1,_0x38c822['constructor']['TYPE'],_0x3b246e['encode'](_0x38c822)),_0x4fc9d6=_0x3b246e['decode'](_0x23fbea,_0x44ec82);return this['listenTo'](_0x309b57,'change:state',(_0x2c1a05,_0x509287,_0x555bce)=>this['_onWsGatewayStateChange'](_0x555bce),{'priority':_0x560f6e['_CHANGE_STATE_EVENT_PRIORITY']}),this['_connectToChannel'](_0x309b57,_0x4fc9d6['channel']),this['_isConnected']=!0x0,this['fire']('connected'),_0x4fc9d6;}['_connectToChannel'](_0x1ea5a0,_0x24525f){this['_channel']=_0x1ea5a0['_getChannel'](0x1,_0x24525f),this['listenTo'](this['_channel'],this['_channel']['getEventName'](_0x4ae3d5['TYPE']),(_0x142c86,_0x1bd713)=>{const _0x315c0e=_0x3b246e['decode'](_0x1bd713,_0x4ae3d5);this['fire']('operationsReceived',_0x315c0e['baseVersion'],_0x315c0e['data'],_0x315c0e['metadata']);});}['_onWsGatewayStateChange'](_0x247677){_0x247677===_0x560f6e['STATE_DISCONNECTED']&&this['disconnect']();}}CollaborativeEditingService['_SERVICE']=0x1;export default CollaborativeEditingService;