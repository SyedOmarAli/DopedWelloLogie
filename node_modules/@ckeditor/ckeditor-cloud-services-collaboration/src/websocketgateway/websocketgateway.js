/*
 *             Copyright (c) 2003-2024, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{io}from'socket.io-client';import _0x3a1ac1 from'url-parse';import{ObservableMixin,priorities,global}from'ckeditor5/src/utils.js';import _0x406135 from'./channel.js';import _0x2233c6 from'./../users/user.js';import _0x10200b from'./../version.js';import _0x93c010 from'./../ckeditorcloudserviceserror.js';import _0x3e8fca from'./../ckeditorcloudservicesservererror.js';import{Encoder,Decoder}from'./parser/parser.js';import _0xb7e684 from'./requestsmanager.js';export var WEB_SOCKET_GATEWAY_STATES;!function(_0x221034){_0x221034['DISCONNECTED']='disconnected',_0x221034['CONNECTING']='connecting',_0x221034['CONNECTED']='connected';}(WEB_SOCKET_GATEWAY_STATES||(WEB_SOCKET_GATEWAY_STATES={}));class WebSocketGateway extends ObservableMixin(){constructor(_0x2f1cef,_0x54c5ae,_0x4de939={},_0x24d58a=io,_0xf4ff4e=_0x2233c6['get']){if(super(),this['_token']=_0x54c5ae,this['_options']=_0x4de939,this['_connectionProvider']=_0x24d58a,this['_userFactory']=_0xf4ff4e,this['_requestsManager']=new _0xb7e684(this),this['_channels']=new Map(),this['_connectionAttempt']=0x0,!_0x2f1cef)throw new TypeError('Api\x20address\x20must\x20be\x20provided.');if(!this['_token'])throw new TypeError('Token\x20must\x20be\x20provided.');this['_options']['requestTimeout']||(this['_options']['requestTimeout']=0x4e20),this['_url']=_0x3a1ac1(_0x2f1cef['replace'](/^(?!(?:\w+:)?\/\/)/,'https://')),this['set']('state',WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']),this['set']('socketId',void 0x0),this['set']('me',void 0x0),this['on']('change:state',async(_0x4f8f52,_0x4157af,_0x1aca63)=>{var _0x148d0d;if(this['_debugEvent']('ws-gw:change:state',_0x1aca63),_0x1aca63!==WebSocketGateway['STATE_CONNECTED']){if(_0x1aca63===WebSocketGateway['STATE_DISCONNECTED'])return this['_requestsManager']['errorAll'](new _0x93c010('Not\x20connected.',this));}else try{this['me']=await this['_userFactory']['call'](_0x2233c6,this,null===(_0x148d0d=this['_socketAuth'])||void 0x0===_0x148d0d?void 0x0:_0x148d0d['userId']);}catch(_0x3a177c){}},{'priority':WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']}),this['on']('error',(_0x1d9e5c,_0x3a93f9)=>{this['_options']['onError']?this['_options']['onError'](_0x3a93f9):console['error'](_0x3a93f9);});}get['sessionId'](){return this['socketId'];}['waitForAllRequests'](_0x27838b){return this['_requestsManager']['waitForAllRequests'](_0x27838b);}['disconnect'](){var _0x142321;this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']&&(null===(_0x142321=this['_socket'])||void 0x0===_0x142321||_0x142321['disconnect'](),this['_socket']=void 0x0,this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']);}async['reconnect'](){this['_socket']||this['state']!==WEB_SOCKET_GATEWAY_STATES['DISCONNECTED']||(await this['_token']['refreshToken'](),await this['_connect']());}static async['connect'](_0x352175,_0x1acc57='local.cs.dev:443/ws-v2',_0x2724cb={},_0x2a0097=io,_0x1b0303=_0x2233c6['get']){const _0x1fe7e2=new WebSocketGateway(_0x1acc57,_0x352175,_0x2724cb,_0x2a0097,_0x1b0303);return await _0x1fe7e2['_connect'](),_0x1fe7e2;}['_sendRequest'](_0x4939de,_0x34d30e,_0xc8cd50){if(!_0x4939de)throw new _0x93c010('`serviceName`\x20must\x20be\x20provided.',this);if(this['state']!==WebSocketGateway['STATE_CONNECTED'])throw new _0x93c010('Not\x20connected.',this);if(!this['_socketAuth']||!this['_socketAuth']['isAuthenticated'])throw new _0x93c010('Not\x20authenticated.',this);const _0x4ebf66=new ArrayBuffer(_0xc8cd50['length']+0x2),_0x385c42=new Uint8Array(_0x4ebf66);return _0x385c42[0x0]=_0x4939de,_0x385c42[0x1]=parseInt(_0x34d30e),_0x385c42['set'](_0xc8cd50,0x2),this['_emit'](0x1,_0x385c42);}['_getChannel'](_0x27e8fd,_0x3acbd7){const _0x50d608=''+_0x27e8fd+_0x3acbd7;return!this['_channels']['has'](_0x50d608)&&this['_socket']&&this['_channels']['set'](_0x50d608,new _0x406135(_0x50d608,this,this['_socket'])),this['_channels']['get'](_0x50d608);}['_connect'](){return new Promise((_0x4cc942,_0x37366e)=>{const _0x3fcfb6=this['_setupSocket']();!this['socketId']&&_0x3fcfb6['io']['on']('reconnect_error',()=>{this['_debugEvent']('reconnect_error'),this['_reconnectionAttemptError'](_0x37366e);}),_0x3fcfb6['once']('connect',async()=>{this['_debugEvent']('once-connect');try{await this['_onConnect'](),_0x4cc942();}catch(_0x113613){_0x37366e(_0x113613);}}),_0x3fcfb6['connect']();});}['_getPortByProtocol'](_0x723f48){return['http:','ws:']['includes'](_0x723f48)?0x50:0x1bb;}['_setupSocket'](){var _0x39536f;if(this['_socket'])return this['_socket'];const _0x1ef416=this['_url']['port']||this['_getPortByProtocol'](this['_url']['protocol']),_0x5c5581=(this['_url']['protocol']||'https:')+'//'+this['_url']['hostname']+':'+_0x1ef416,_0x31c283=this['_url']['pathname']['match'](/^\/.*\/ws/)?this['_url']['pathname']['split']('/ws')[0x0]:'',_0xd612c3=this['_connectionProvider'](_0x5c5581,{'parser':{'Encoder':Encoder,'Decoder':Decoder},'path':_0x31c283+'/ws-v2/ws','transports':['websocket'],'timeout':void 0x0!==this['_options']['timeout']?this['_options']['timeout']:0x1388,'reconnection':void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect'],'reconnectionDelay':0x3e8,'reconnectionDelayMax':0x1388,'rejectUnauthorized':void 0x0===this['_options']['rejectUnauthorized']||this['_options']['rejectUnauthorized'],'query':{'version':_0x10200b},'agent':null!==(_0x39536f=this['_options']['agent'])&&void 0x0!==_0x39536f&&_0x39536f,'closeOnBeforeunload':!0x1});return this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],_0xd612c3['on']('connect',()=>{this['_debugEvent']('connect'),this['socketId']=_0xd612c3['id'];}),_0xd612c3['on']('connect_error',_0xd0cd13=>{this['_debugEvent']('connect_error',_0xd0cd13);}),_0xd612c3['on']('disconnect',()=>{this['_debugEvent']('disconnect'),this['_onDisconnect']();}),_0xd612c3['io']['on']('reconnect',async()=>{this['_debugEvent']('reconnect'),await this['_onReconnect']();}),_0xd612c3['io']['on']('reconnect_attempt',_0x317a3a=>{this['_debugEvent']('reconnect_attempt',_0x317a3a),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],this['_connectionAttempt']=_0x317a3a;}),_0xd612c3['on']('unauthorized',_0x5a09f2=>{this['_debugEvent']('unauthorized'),this['_onUnauthorized'](_0x5a09f2);}),_0xd612c3['on']('authenticationRequest',async _0x376218=>{this['_debugEvent']('authenticationRequest',_0x376218['attempt']),await this['_onReconnect']();}),this['_socket']=_0xd612c3,_0xd612c3;}['_emit'](_0x3808e7,_0x428b0c){const _0xf24d3c=this['_socket'];return this['_requestsManager']['send'](_0x5ae269=>{_0xf24d3c['emit'](_0x3808e7,_0x428b0c,(_0x420f70,_0x3d4fd1)=>{if(_0x420f70)return _0x5ae269['error'](_0x3e8fca['fromPublicError'](_0x420f70));_0x5ae269['response'](_0x3d4fd1);});},this['_options']['requestTimeout']);}['_addAuthData'](_0x3ccc2d,_0x38d517){this['_socketAuth']={'environmentId':_0x3ccc2d,'userId':_0x38d517,'isAuthenticated':!0x0};}['_removeAuthData'](){this['_socketAuth']=void 0x0;}async['_onConnect'](){await this['_authenticate'](this['_token']['value']),this['state']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'];const _0x556de8=async(_0x1862ee,_0x53e89d,_0x5c6dfe)=>{this['_debugEvent']('token:value:change');try{await this['_authenticate'](_0x5c6dfe);}catch(_0x401151){}};this['_token']['on']('change:value',_0x556de8),this['_socket']['io']['off']('reconnect_error'),this['on']('disconnect',()=>{this['_token']['off']('change:value',_0x556de8);});}async['_onReconnect'](){await this['_token']['refreshToken'](),await this['_onConnect']();}['_onDisconnect'](){this['state']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],this['_connectionAttempt']=0x0,this['fire']('disconnect');for(const _0x47e9cf of this['_channels']['values']())_0x47e9cf['remove']();this['_channels']['clear'](),void 0x0===this['_options']['autoReconnect']||this['_options']['autoReconnect']||(this['_socket']=void 0x0);}['_debugEvent'](_0x5b861d,_0x487ca4){if(!this['_isDebugModeEnabled']())return;const _0x229e4a=void 0x0!==_0x487ca4?',\x20data:\x20'+_0x487ca4:'';console['info'](new Date()['toLocaleString']()+'\x20'+_0x5b861d+_0x229e4a);}['_reconnectionAttemptError'](_0x34eee8){this['_connectionAttempt']>=0x2&&(this['disconnect'](),_0x34eee8(_0x93c010['fromPublicError']({'message':'The\x20number\x20of\x20initial\x20connection\x20attempts\x20exceeded.','explanation':'Three\x20initial\x20connection\x20attempts\x20failed.\x20It\x20can\x20be\x20caused\x20by\x20a\x20slow,\x20unstable,\x20missing\x20or\x20blocked\x20Internet\x20connection.','action':'Please\x20verify\x20the\x20stability\x20of\x20your\x20Internet\x20connection\x20and\x20ensure\x20that\x20no\x20antivirus\x20or\x20firewall\x20software\x20blocks\x20the\x20Web\x20Socket\x20protocol\x20connections.'})));}['_onUnauthorized']({error:_0x153533}){this['_removeAuthData'](),this['fire']('error',_0x3e8fca['fromPublicError'](_0x153533));}async['_authenticate'](_0x152985){try{this['_debugEvent']('authenticate:start');const _0x596aca=await this['_emit'](0x2,{'token':_0x152985});this['_debugEvent']('authenticate:success','envId:\x20'+_0x596aca['environmentId']+',\x20userId:\x20'+_0x596aca['userId']),this['_addAuthData'](_0x596aca['environmentId'],_0x596aca['userId']);}catch(_0x458d13){throw this['_debugEvent']('authenticate:error',_0x458d13['message']),this['_removeAuthData'](),_0x458d13;}}['_isDebugModeEnabled'](){var _0x46858a;if(!global['window']['localStorage'])return!0x1;return'true'===(null!==(_0x46858a=global['window']['localStorage']['getItem']('csClientDebugMode'))&&void 0x0!==_0x46858a?_0x46858a:'false')['toLowerCase']();}}WebSocketGateway['STATE_DISCONNECTED']=WEB_SOCKET_GATEWAY_STATES['DISCONNECTED'],WebSocketGateway['STATE_CONNECTING']=WEB_SOCKET_GATEWAY_STATES['CONNECTING'],WebSocketGateway['STATE_CONNECTED']=WEB_SOCKET_GATEWAY_STATES['CONNECTED'],WebSocketGateway['_CHANGE_STATE_EVENT_PRIORITY']=priorities['get']('highest')+0xf423f;export default WebSocketGateway;